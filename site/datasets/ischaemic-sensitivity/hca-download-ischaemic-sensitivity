#!/bin/bash

DATASET_NAME="ischaemic_sensitivity"

REPLICA=aws
HCA_CONFIG=~/.config/hca/config.json
TMPDIR="$(pwd)/.hca-tmp"
LOGFILE="${TMPDIR}/log"
BUNDLE_DIR=${DATASET_NAME}

function initialize() {
    set -euo pipefail

    mkdir -p "${TMPDIR}"
    cp /dev/null "${LOGFILE}"
}

function install_hca_tool() {
    echo "Installing hca tool (see ${LOGFILE} for errors)..."

    if ! pip install hca --upgrade --ignore-installed six >> "${LOGFILE}" 2>&1 ; then
        echo -e "\n\nThat failed, trying again as superuser.  You may be prompted for your password..."
        sudo pip install hca --upgrade --ignore-installed six 2>&1 >> "${LOGFILE}"
    fi

    HCA=hca
    if ! type ${HCA} >/dev/null 2>&1; then
        HCA=~/.local/bin/hca
    fi
}

function check_hca_tool_config() {
    echo "Checking hca tool config..."
    if [ -e ${HCA_CONFIG} ] ; then
        if grep -q "\"swagger_url\": \"https://dss.data.humancellatlas.org/v1/swagger.json\"" ${HCA_CONFIG} ; then
        # We're good
        :
        else
            echo -e "It looks like you have used the \"hca\" tool before and it has been configured to use an" \
                 "environment other than production.\nPlease move, remove or correct your ${HCA_CONFIG} file."
            exit 1
        fi
    fi
}

function download_bundles() {
    mkdir -p "${DATASET_NAME}"
    for uuid in ${bundles} ; do
        if [ -d "${BUNDLE_DIR}/${uuid}" ] ; then
            echo "Skipping $uuid, already downloaded."
        else
            echo "Downloading ${uuid} to ${BUNDLE_DIR}/${uuid}..."
            (cd "${TMPDIR}"; ${HCA} dss download --bundle-uuid ${uuid} --replica ${REPLICA} >> "${LOGFILE}")
            mv "${TMPDIR}/${uuid}" "${BUNDLE_DIR}"
            echo ""
        fi
    done
}

bundles="
7050c147-8dae-4e47-b260-b729bece41cd
b95f8b90-1488-4506-9186-a42cfe57ca25
16971394-3dec-4604-a9d8-65c7590652e6
8d7bfcb3-fca8-4e34-98d4-c0b2a881004c
84be47a9-3dfd-409e-8ad3-b97c4b6f0f3c
a5b72567-b534-4c1d-abf7-cde41a451408
0cbd9be1-5666-4341-a364-d5fdd6eed2a9
"

initialize
install_hca_tool
check_hca_tool_config
download_bundles
