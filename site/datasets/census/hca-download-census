#!/bin/bash

DATASET_NAME="immune_census"

REPLICA=aws
HCA_CONFIG=~/.config/hca/config.json
TMPDIR="$(pwd)/.hca-tmp"
LOGFILE="${TMPDIR}/log"
BUNDLE_DIR=${DATASET_NAME}

function initialize() {
    set -euo pipefail

    mkdir -p "${TMPDIR}"
    cp /dev/null "${LOGFILE}"
}

function install_hca_tool() {
    echo "Installing hca tool (see ${LOGFILE} for errors)..."

    if ! pip install hca --upgrade --ignore-installed six >> "${LOGFILE}" 2>&1 ; then
        echo -e "\n\nThat failed, trying again as superuser.  You may be prompted for your password..."
        sudo pip install hca --upgrade --ignore-installed six 2>&1 >> "${LOGFILE}"
    fi

    HCA=hca
    if ! type ${HCA} >/dev/null 2>&1; then
        HCA=~/.local/bin/hca
    fi
}

function check_hca_tool_config() {
    echo "Checking hca tool config..."
    if [ -e ${HCA_CONFIG} ] ; then
        if grep -q "\"swagger_url\": \"https://dss.data.humancellatlas.org/v1/swagger.json\"" ${HCA_CONFIG} ; then
        # We're good
        :
        else
            echo -e "It looks like you have used the \"hca\" tool before and it has been configured to use an" \
                 "environment other than production.\nPlease move, remove or correct your ${HCA_CONFIG} file."
            exit 1
        fi
    fi
}

function download_bundles() {
    mkdir -p "${DATASET_NAME}"
    for uuid in ${bundles} ; do
        if [ -d "${BUNDLE_DIR}/${uuid}" ] ; then
            echo "Skipping $uuid, already downloaded."
        else
            echo "Downloading ${uuid} to ${BUNDLE_DIR}/${uuid}..."
            (cd "${TMPDIR}"; ${HCA} dss download --bundle-uuid ${uuid} --replica ${REPLICA} >> "${LOGFILE}")
            mv "${TMPDIR}/${uuid}" "${BUNDLE_DIR}"
            echo ""
        fi
    done
}

bundles="
aa0b0d69-19f1-40c0-b7e6-a7363890813f
72fbb57d-d144-4e62-afbd-911f9f1a02ca
2c97310c-9a1c-4521-83ad-db7065846e0d
0f7ef08e-dc73-4ffd-950c-a6ff0fa5314a
4c8e10d8-a0f7-415f-800e-7c16ed55e565
046c94fb-632b-47c3-a318-d96a8c17337f
f630a972-b438-4f71-9949-d4feeb1adf64
a22226dc-d891-449e-9d1a-76513f9cde45
19633294-ec0a-4dba-a1df-545b13db4adc
51a8dd49-b719-4aa7-aa43-840dfd191ec8
619907e8-44d7-4bc4-aca1-b525b2ada3f1
5376da08-8b3b-450e-a709-ca0a1138262f
f7950f7e-68ea-43ff-9248-227c9988b3ef
59ebefff-499d-46d2-9b18-b0db118e7487
b274e018-b6cc-4e11-904f-ad6b5ddf904c
a5285f2d-7e7d-4ea6-839d-81b23c0a3045
4dbed2a8-3755-47ff-9808-d602ae4985f9
9ea77648-1b86-4120-8183-606b16099790
99d2d975-2069-4d13-82e9-801c705a162f
df82c6d9-e44e-472e-8031-520f5f6aba15
9575abb1-0642-4894-aa75-ecc656d1e6e0
72822c2a-e21a-4286-bd31-4534b8fa5c17
fba43133-0359-498d-aa44-132da6d266d5
7eb683ab-9e83-45c3-b82b-b097e9260e9f
7317730d-c7cc-40e1-817e-c99ae55b5ee8
72fd8801-70e6-4212-b432-fb1e2bbc5bff
8fb8c441-b987-453b-b53c-43b8e919c426
02078aee-2cc1-4137-b465-bb1a68fa6ec2
22489454-dec7-4b42-8482-f685db862ef9
a3ac1697-f6e7-4928-b3d9-38245b08cbaa
b7fcce50-9b30-4daf-b626-c88ca5eb8698
ec757cd3-a592-4166-96de-9a5c666c2eb9
2cf53832-f6d3-43d3-84ff-609b32e4248c
aa4e8ed9-4b79-40cc-b01a-9f8a3f2adec2
a9985b88-4b99-4e96-9402-891d21b3cd83
1fa41bfd-e9db-4512-bdb5-0492d927dfdc
50eb190b-ea45-4d81-a9a1-41de1933a972
5d4a3b77-d2ff-4470-b7a5-39c232e40225
9c2ec4a2-e332-4706-afbc-f2f777d4db8a
3694ee97-2385-4c4e-a4a0-274ad55f6534
4f34035b-9ac0-4df1-98d4-b513f127573e
b1594f66-4f8a-42ea-bf10-6d7b3fbb449f
2c80a486-3ea6-4b2a-8716-60eceeb17936
352a2d46-1f5d-4ddc-9ef2-d6ccdbfd912d
7869ddf1-a054-46e5-a5c1-85c2937209b9
e66525a1-5d65-4e16-803a-8232e461996a
dbc19413-cdc3-49cf-adb5-94cfee1dc70a
45075c2d-188f-43a0-b676-6ec241e7fdf0
4c79096f-f13b-40d0-9b42-472b75f326c3
b0cd2958-d96d-4e64-a56e-1c572e648625
3c377c12-b49f-4b28-8a84-e27f393279ad
526b6979-23fb-4208-9470-ed18c29e9a8f
c28f3b12-25b9-45c8-8853-b93bd14dbdd5
10399990-0fda-477c-bbe5-090a84593942
814891b0-72f8-475b-afe0-3497a960f2ad
b81a8365-ba4b-40ea-b6cd-d0091895c59e
8fde3f94-63f9-4cc2-a306-c8e91a6fe282
573eb11e-f6e1-451b-880d-7fd98dc471db
c8eff778-99f9-48d6-9e47-b0ff79e6747b
cc5cb847-caf5-4135-a274-d203032877de
0b9de7f6-11a1-4641-8030-9eb83d4c5e0c
b212e6ea-dda8-48cf-9a37-7db2d8ed0ffc
137a5379-eda5-4bca-990b-61b46578e476
4e9c083b-7d2c-4511-8869-9ca7793ac537
0f96f5e5-383b-4167-ac45-2268d31aeaac
68549b32-47dc-4924-9168-f1241d67b654
2a510062-8c85-412f-acf8-eec7c82b0941
735e1f93-8803-459b-8b8b-7eb80afa5ae6
2b8f66be-3fcc-4887-a5de-17cfb86a78ca
ad56137c-9ff3-4b9e-bc3a-a8558cc0b6d8
4399fca9-a42f-4684-90b8-c7cbbbbb7b4a
61310442-a547-4f0e-adaa-41f863c14b17
e47652fe-3dc7-48a5-ab8d-e59f69b029fc
a4ec2214-ad26-41bc-9e35-b0192b4b9c1c
f630f7c2-b94d-48c4-ba7f-1a67261b0ec2
75be3866-d06d-42e8-ab72-e6cd6ff869c3
ec06c6f5-26d7-4d60-8c61-2f88664f826b
805e7743-d352-4070-b507-c461991a68ad
26a89982-7dc3-44fe-88f5-b691c4afdb86
7136bbb2-11d8-4372-9e6d-abfc061b74b3
3d5dfb8c-e866-4dd5-a955-48601c5e93e1
03711fe8-e6ba-4c96-891f-0a9a788caf0e
14b77ad0-8f48-43f8-a861-e7d87615863b
7055a75e-701e-4171-b739-ebcb6193dafc
6b12e50a-86c7-459a-8476-5eecbfd178c6
e7d15af0-851c-45d8-9845-a7e2f469988e
9cc12283-09c7-47af-859f-e44693fc806d
9b7ed051-de0b-436c-ac63-a6543d5a7416
82fd92bc-89c9-499f-88ac-67b2453d145d
f4f141f8-575b-4b5d-ac1f-4f07ce90ef0d
a1d64323-24e6-48f6-8ad2-1d91eaeb4d68
67863461-b85c-4919-b25a-674c6547fc2a
d8276348-1270-4a21-ac0d-6102737af935
3ae81c3c-a871-4a0a-9bc9-a5b0e9c869ab
9205f350-1b13-461b-94d3-929b553d4b64
5c035b16-8e1d-4fe3-abfa-974eabacb803
20df1f20-888c-4267-b685-9674d554dbe5
39462fe4-7205-43ee-b1e4-dd98826b561d
49fc645d-583a-4700-a2c5-e0ae65fe26af
3de2c54d-53b6-4798-bbce-5cb1a5b38987
63d08856-41f1-4912-a9ce-2b7dd78f774b
80f3c360-957a-48c6-8918-086167df6665
3338583e-f5e2-452e-9f15-8e6044af49e7
0553bae2-8780-4abe-ab07-ea6bb90b7bc6
3187a93e-f3b8-4274-9d2a-2fa2ff4286d4
290b15de-fb98-4ceb-8d19-7265a9df53b1
d4ada594-bdd4-4c93-8063-55421484461f
42d4dd09-0033-4dce-b0b3-75d7dd291dd4
b84ba599-2a36-49f4-b1fd-523f70c5f06c
329c1d13-0e71-4a8b-b1be-c2ee4d126a03
87158feb-440f-4722-bce6-6458dd82507c
e6d04ca5-0608-4ac7-a358-dc6f8da20b50
cc8f61d4-d6d1-4dc1-9ebe-85c99b6f168d
e9a7771e-a1b0-4554-8a05-03a079bfa2e5
2d236f4c-d10c-4c81-95ba-8fd7a933f757
66f36090-4bc7-43d8-be42-ab6a202b0ffa
86c3271c-c146-4268-96e2-d1c6b1cea670
5da1ffaf-2225-4ee3-a161-b28d49341926
92ec3ac0-b420-4de3-8371-0ed5619f5f7a
f4f255c3-a96a-4ffe-889a-f77cf33b0e11
60ef4ff5-5f16-4083-8522-8ae1486c9243
d185dea6-9156-4ccf-bcd9-3e6899968555
7a394874-ddf7-4a13-8156-6eba702a5881
53984469-e686-42da-9667-6c983f8d2b32
1a7b6714-3b9b-48c1-955d-f5835cac2eaa
87697d8d-39af-47be-baae-8d1dd5de1efb
f8af86d8-8ef8-4b71-b440-be2eb744cb53
2db12ba5-e02b-4390-b8d0-4995a9733e8d
9e4eefc1-533e-433e-a747-cffc90ec5c2c
603d7777-ba3f-4aba-bd7a-bd1760c9c2c8
b00407d0-581c-4852-bf0a-a0f01720f55c
ff5e8927-d5cc-4121-85b4-872a15ae1940
f5f2672d-214a-42c7-a66b-52ad1315167d
7cc78ea0-6311-4921-8cfb-17cc433a402a
6b45f194-2fea-4b58-9b2f-53d1299b1ceb
83131426-fc57-42c8-81cb-fb064f18fefc
e340f7a6-68d8-45b1-8f1a-50f59f42f9fc
9b7b77a5-0eec-4271-9cfd-a794e580c608
646d0f20-2ad3-4a9c-b029-0bd329b7924c
49980014-ef8e-4b14-9097-453f4949f89f
d88b1026-966f-4fed-807c-91ca17089b2b
dbe6dd35-1384-4255-90aa-7203e0bf70df
d9576be8-0e56-43b5-b02e-fc6b312afb88
fb858ca8-2ebf-4e8f-9462-2a27f2a3608b
4e3dbd8a-895b-4313-850b-fe262015316a
a3da1f10-b8a8-4586-8a3d-07d98efce65f
2117b7ff-632b-404b-b95f-6566fdbcda87
2ec01f75-9136-47bc-b0c5-2439da801b5e
6f1ecb9a-b8b6-4a7f-a65e-ca9f5dfa27c9
3735447f-d3ea-4d18-a2d4-68b21cfc8d00
64542625-bdd0-4fa6-8b66-01fd24db7b4f
fc236a46-f98f-4866-91e6-40610dabb288
0abfad2b-0216-4892-a6f7-90e6f78ac2a8
a56ef42c-3fc6-48ea-9689-03cbc5628f66
0c91510a-4b84-4024-9aee-74ff2f4c7ff7
15a3d6f6-9112-4f73-9114-371e0fbefd76
fc13fe6d-ffbb-4b44-b041-ed71a4a525f0
8085f52c-87b1-4989-b412-2cb0b93c3c70
0cdfe156-29d2-4e24-b3b6-1139b62dd2ee
993320c3-b4b4-4732-ac21-8ab989e527a5
4e7ee6b2-dd6e-4a2b-b1d7-b1bed3a4632b
a9fb68e8-84bf-43f4-be50-c1a6512aa24c
5c25ba0a-7f14-4404-82b6-65c770a747d9
1c527370-4919-4946-8851-5ee0cca9ddee
58b032eb-7a3b-41a9-a7c5-202fc0871ad4
bc00fccc-813f-4fbd-bcf5-65d78e0ac107
33f15da5-0bc9-4e56-b987-b240b0c130eb
42c166b6-4ff2-40b2-bbc9-0571442aaea3
b7db511a-bf23-4199-ac7d-3bef65b51b07
64802518-d5f4-4474-8a63-3512225929d9
bb75dc51-9e2e-4da7-baab-eb77a52551a2
5d907726-767b-4b68-bf47-f968a44f6100
f5197969-9e86-4c54-8aa2-6c916c83cb81
465495d7-08fa-4ef2-b9e6-a89dd3c91551
272361a8-7890-4639-8059-f66bf733e776
29ad9dc8-5f36-41de-8bc4-ac9a16313a80
9885cfea-632f-41f6-a04b-f93d0e29a482
b8f7b3c6-2fca-41c2-bb7e-d0129fd1ce7f
07807e93-ce9f-4234-a57b-c0ff6e465b4a
a4f8fa8f-4790-4c11-895c-ce5f2e91199f
ae2e2ab0-9789-4bdb-8e15-668ada3f4f9e
a6da41ff-14c4-43a1-a402-a2ebeda52642
c2f1b1ff-aaf3-416a-9708-8d35b9c062d6
a7d36556-3d67-44e1-9ab8-c45c9d41faed
88e874a7-3008-4293-b6d7-40e9276f8060
ddc30150-cb40-4ed7-bdac-6f1b0ef44a81
4806f5ed-3192-4f99-8e29-2acaa17cbadb
2fc47f15-d1dc-43fa-a9f0-aea845e16fb7
249fca68-9519-47b8-8cd3-ed5039f80484
07f47dd8-03f4-4d59-b79d-b00c17dfe010
8578a1e0-09f0-44d0-8436-6d87b821601e
88400af6-2072-452e-b837-2a46037594be
eaa0d88a-0a0a-4b74-9f1d-1a3477c7d314
292b00bb-b64e-4c8c-acdb-8fb3aca783f5
5acafbf6-8e71-4a22-b1cb-2028a446b447
c952d430-7978-49cf-b14b-357b6bdd9cdd
63852357-d8be-47de-87da-f9b5bd871416
0e46cb93-8e70-4306-8e7b-c730beeacf38
736a3532-4f9f-4349-9421-2b622c21b102
0280a9d7-75f2-40d5-8ecb-967288cbeae3
7246922b-f09f-469f-944b-6f1356c8e03b
dab42d9a-0939-4686-91db-5001173abc76
5e412794-6d42-4dc4-94f3-80630211e8c3
712021a4-1039-4cd6-868e-441181261736
51afae9f-d682-4099-b3a7-27d60eddb8c8
e4fb457d-b267-44e7-b844-49e0c35f6f4b
2c25987e-0880-4299-a1a0-82d5bb857b52
21a33469-2b28-4ef5-931e-dceba4c9c4b2
6bc4416e-0b38-4d4e-914e-7c6f9e8127e3
5ad1fa73-611f-4536-aa73-9bad3b4303dd
3fbf76a1-ece8-47c6-a548-b3a62bacd08a
656d1215-af35-4c6d-9e50-f64c6cf233f6
ffc39f97-3276-4e90-a4b9-e91bdabf2712
81b5c37e-ed5d-4fce-b1da-f07e02ff1b7b
f7e9241b-f530-42ba-b584-c41f7afb8d6d
f52e46ec-5583-4e62-b188-c94f4c745d11
4a0507b6-1f6d-4158-9c24-8ca08cea8fa1
d88fef49-9b98-462f-8e65-7b34d3f44d26
2d1d1cbd-c37b-499c-9b58-7b1d7184146e
898a8990-1215-479f-9e2d-db450362a10a
f87476e0-221d-4e9d-899b-5f49ea793d8d
cbf393d4-74bb-410f-a7b3-f51424ee12ea
e220c4c5-70b9-4875-a1d9-8bf507ae42b4
02ad354f-c69e-43bc-8c5c-12d29477f84d
7332ba13-334c-4eda-aad0-292e8d32312d
4cf02dd9-992b-4073-ab28-865ae8bb8ab7
063326b1-d8a9-4fde-b4e2-2b39a9384899
385ff624-1b24-4fa6-af05-66b0bcb7faaf
aa11e02b-f181-4e7a-bb5e-388334f85eec
60ed0d03-c298-44c4-ad22-082e084f4f93
33ff7ea7-237f-4bad-bd33-d3a4f39e39cc
6747b80a-5274-4439-bcab-c46624ccf211
a0ccb876-ec02-42a6-8bc3-d5ec9c70b925
96787afb-014d-4096-a6ec-ea1ff19d64e6
3e2c700f-5fcd-4b26-99db-7dd224de982e
0af0cf42-61a9-4d66-908b-eb23581913af
8a587169-d0cd-4324-9558-f7bb4ea71c8c
9fe57caa-8905-404c-9a8d-ead37c09325c
ee01e416-3dec-4eea-a5d3-2addd089fa1b
2b713450-781f-49ee-81c9-4d4d703a1a11
bcaf51c9-48e6-4a5e-8b29-d991d2a404ca
b3b5deea-5ec5-4397-b084-cf45e860c85d
7b1c32c9-6486-4f5e-8662-160e417d16ce
457ba130-420b-4753-843b-bb992dec9af0
b2af823d-8e9f-4e44-bff6-ea93d05a841d
62db1fcd-2015-4ff9-b701-dbf105821193
ae6663f5-9b52-488f-a2d5-60cb679cbe15
ca87a63f-c7a7-4b0f-bafb-a8f6c764553f
fb8dc357-144c-4a1e-832b-2aaa48814375
6d4445eb-a1cc-409c-aaa0-d9c5f50a9711
c03b2ccd-02af-4710-a23f-0d49bffe0f55
21bcadd2-356a-4350-b4e0-77d58da7769b
59b8b2ea-6c85-4412-989b-cb4dfd746085
c2491238-8248-46b2-89f4-db3f42a363a2
"

initialize
install_hca_tool
check_hca_tool_config
download_bundles
